<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Viagens</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #eef2f3; }

    .formulario {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .formulario input, .formulario button {
      flex: 1 1 250px;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:hover {
      background-color: #45a049;
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.95);
    }

    #resumo {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow-x: auto;
      display: block;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.05);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      white-space: nowrap;
    }

    #busca {
      width: 100%;
      margin: 20px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #grafico-container {
      margin-top: 30px;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Controle de Viagens</h1>

  <div class="formulario">
    <input id="cliente" placeholder="Nome do Cliente" />
    <input id="contato" placeholder="Contato" />
    <input id="data" type="date" />
    <input id="origem" placeholder="Origem" />
    <input id="destino" placeholder="Destino" />
    <input id="kmInicial" type="number" placeholder="KM Inicial" />
    <input id="kmFinal" type="number" placeholder="KM Final" />
    <input id="combustivel" type="number" placeholder="Combust√≠vel (R$)" />
    <input id="pedagios" type="number" placeholder="Ped√°gios (R$)" />
    <input id="outros" type="number" placeholder="Outros (R$)" />
    <input id="ajudante" type="number" placeholder="Ajudante (R$)" />
    <input id="frete" type="number" placeholder="Valor do Frete (R$)" />
    <button onclick="adicionarViagem()">Adicionar Viagem</button>
    <button onclick="exportarParaExcel()">Exportar para Excel</button>
    <button onclick="limparTabela()">Limpar Tabela</button>
  </div>

  <input type="text" id="busca" placeholder="Buscar por Cliente, Origem ou Destino" onkeyup="filtrarTabela()" />

  <div id="resumo">
    <h2>Resumo</h2>
    <p>Total de Viagens: <span id="resumo-viagens">0</span></p>
    <p>Total de KM Rodado: <span id="resumo-km">0</span> km</p>
    <p>M√©dia de Custo por KM: R$ <span id="resumo-media-km">0.00</span></p>
    <p>Total de Frete: R$ <span id="resumo-frete">0.00</span></p>
    <p>Total de Gastos: R$ <span id="resumo-gastos">0.00</span></p>
    <p>Total de Saldo Final: R$ <span id="resumo-saldo">0.00</span></p>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Contato</th>
        <th>Data</th>
        <th>Origem ‚Üí Destino</th>
        <th>KM Rodado</th>
        <th>Combust√≠vel</th>
        <th>Ped√°gios</th>
        <th>Outros</th>
        <th>Ajudante</th>
        <th>Gastos Totais</th>
        <th>Custo/KM</th>
        <th>Frete</th>
        <th>Saldo Final</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="grafico-container">
    <canvas id="graficoResumo" height="120"></canvas>
  </div>

<script>
let chart;

function adicionarViagem() {
  const cliente = document.getElementById("cliente").value;
  const contato = document.getElementById("contato").value;
  const data = document.getElementById("data").value;
  const origem = document.getElementById("origem").value;
  const destino = document.getElementById("destino").value;
  const kmInicial = parseFloat(document.getElementById("kmInicial").value);
  const kmFinal = parseFloat(document.getElementById("kmFinal").value);
  const combustivel = parseFloat(document.getElementById("combustivel").value);
  const pedagios = parseFloat(document.getElementById("pedagios").value);
  const outros = parseFloat(document.getElementById("outros").value);
  const ajudante = parseFloat(document.getElementById("ajudante").value);
  const frete = parseFloat(document.getElementById("frete").value);

  if (isNaN(kmInicial) || isNaN(kmFinal) || isNaN(combustivel) || isNaN(pedagios) || isNaN(outros) || isNaN(ajudante) || isNaN(frete)) {
    alert("Por favor, preencha todos os campos corretamente.");
    return;
  }
  if (kmFinal < kmInicial) {
    alert("KM Final n√£o pode ser menor que o KM Inicial.");
    return;
  }

  const kmRodado = kmFinal - kmInicial;
  const totalGastos = combustivel + pedagios + outros + ajudante;
  const custoPorKm = kmRodado > 0 ? (totalGastos / kmRodado).toFixed(2) : "0.00";
  const saldoFinal = (frete - totalGastos).toFixed(2);
  const dataFormatada = new Date(data).toLocaleDateString("pt-BR");

  const row = `<tr>
    <td>${cliente}</td><td>${contato}</td><td>${dataFormatada}</td>
    <td>${origem} ‚Üí ${destino}</td><td>${kmRodado} km</td>
    <td>R$ ${combustivel.toFixed(2)}</td><td>R$ ${pedagios.toFixed(2)}</td>
    <td>R$ ${outros.toFixed(2)}</td><td>R$ ${ajudante.toFixed(2)}</td>
    <td>R$ ${totalGastos.toFixed(2)}</td><td>R$ ${custoPorKm}</td>
    <td>R$ ${frete.toFixed(2)}</td><td>R$ ${saldoFinal}</td>
    <td>
      <button onclick="editarLinha(this)">‚úèÔ∏è</button>
      <button onclick="excluirLinha(this)">üóëÔ∏è</button>
    </td>
  </tr>`;

  document.querySelector("#tabela tbody").insertAdjacentHTML("beforeend", row);
  document.querySelectorAll("input").forEach((input) => (input.value = ""));
  localStorage.removeItem("formTemp");
  salvarDadosLocalmente();
  atualizarResumo();
}

function excluirLinha(botao) {
  if (confirm("Tem certeza que deseja excluir esta viagem?")) {
    const linha = botao.parentElement.parentElement;
    linha.remove();
    salvarDadosLocalmente();
    atualizarResumo();
  }
}

function editarLinha(botao) {
  const linha = botao.parentElement.parentElement;
  const celulas = linha.querySelectorAll("td");

  document.getElementById("cliente").value = celulas[0].textContent;
  document.getElementById("contato").value = celulas[1].textContent;
  document.getElementById("data").value = formatarDataParaInput(celulas[2].textContent);
  
  const origemDestino = celulas[3].textContent.split(" ‚Üí ");
  document.getElementById("origem").value = origemDestino[0];
  document.getElementById("destino").value = origemDestino[1];

  document.getElementById("kmInicial").value = "";
  document.getElementById("kmFinal").value = "";

  document.getElementById("combustivel").value = parseFloat(celulas[5].textContent.replace("R$ ", "").replace(",", "."));
  document.getElementById("pedagios").value = parseFloat(celulas[6].textContent.replace("R$ ", "").replace(",", "."));
  document.getElementById("outros").value = parseFloat(celulas[7].textContent.replace("R$ ", "").replace(",", "."));
  document.getElementById("ajudante").value = parseFloat(celulas[8].textContent.replace("R$ ", "").replace(",", "."));
  document.getElementById("frete").value = parseFloat(celulas[11].textContent.replace("R$ ", "").replace(",", "."));

  linha.remove();
  salvarDadosLocalmente();
  atualizarResumo();
}

function formatarDataParaInput(dataBR) {
  const partes = dataBR.split("/");
  return `${partes[2]}-${partes[1]}-${partes[0]}`; // yyyy-mm-dd
}

function exportarParaExcel() {
  const tabela = document.getElementById("tabela");
  const workbook = XLSX.utils.table_to_book(tabela, { sheet: "Viagens" });
  XLSX.writeFile(workbook, "controle_viagens.xlsx");
}

function salvarDadosLocalmente() {
  const linhas = Array.from(document.querySelectorAll("#tabela tbody tr")).map(tr =>
    Array.from(tr.children).map(td => td.textContent)
  );
  localStorage.setItem("viagens", JSON.stringify(linhas));
}

function carregarDadosSalvos() {
  const dados = JSON.parse(localStorage.getItem("viagens"));
  if (!dados) return;
  dados.forEach(celulas => {
    const row = `<tr>${celulas.map(conteudo => `<td>${conteudo}</td>`).join("")}</tr>`;
    document.querySelector("#tabela tbody").insertAdjacentHTML("beforeend", row);
  });
  atualizarResumo();
}

function limparTabela() {
  if (!confirm("Tem certeza que deseja apagar todos os dados?")) return;
  document.querySelector("#tabela tbody").innerHTML = "";
  localStorage.removeItem("viagens");
  localStorage.removeItem("formTemp");
  atualizarResumo();
}

function atualizarResumo() {
  const linhas = document.querySelectorAll("#tabela tbody tr");
  let totalViagens = 0, totalKm = 0, totalFrete = 0, totalGastos = 0, totalSaldo = 0;
  const labels = [], fretes = [], gastos = [], saldos = [];

  linhas.forEach(linha => {
    const celulas = linha.querySelectorAll("td");
    totalViagens++;
    const km = parseFloat(celulas[4].textContent);
    const gasto = parseFloat(celulas[9].textContent.replace("R$ ", "").replace(",", "."));
    const frete = parseFloat(celulas[11].textContent.replace("R$ ", "").replace(",", "."));
    const saldo = parseFloat(celulas[12].textContent.replace("R$ ", "").replace(",", "."));
    const destino = celulas[3].textContent;

    totalKm += km;
    totalGastos += gasto;
    totalFrete += frete;
    totalSaldo += saldo;

    labels.push(destino);
    fretes.push(frete);
    gastos.push(gasto);
    saldos.push(saldo);
  });

  document.getElementById("resumo-viagens").textContent = totalViagens;
  document.getElementById("resumo-km").textContent = totalKm;
  document.getElementById("resumo-media-km").textContent = (totalKm > 0 ? (totalGastos / totalKm).toFixed(2) : "0.00");
  document.getElementById("resumo-frete").textContent = totalFrete.toFixed(2);
  document.getElementById("resumo-gastos").textContent = totalGastos.toFixed(2);
  document.getElementById("resumo-saldo").textContent = totalSaldo.toFixed(2);

  renderizarGrafico(labels, fretes, gastos, saldos);
}

function filtrarTabela() {
  const filtro = document.getElementById("busca").value.toLowerCase();
  const linhas = document.querySelectorAll("#tabela tbody tr");

  linhas.forEach(linha => {
    const texto = linha.textContent.toLowerCase();
    linha.style.display = texto.includes(filtro) ? "" : "none";
  });
}

function renderizarGrafico(labels, fretes, gastos, saldos) {
  const ctx = document.getElementById("graficoResumo").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        { label: "Frete", backgroundColor: "#4caf50", data: fretes, borderRadius: 5 },
        { label: "Gastos", backgroundColor: "#f44336", data: gastos, borderRadius: 5 },
        { label: "Saldo", backgroundColor: "#2196f3", type: "line", borderColor: "#2196f3", backgroundColor: "transparent", tension: 0.4, fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        title: { display: true, text: "Resumo por Viagem" }
      },
      scales: { y: { beginAtZero: true } }
    }
  });
}

carregarDadosSalvos();
</script>
</body>
</html>
