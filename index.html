<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Viagens</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: #f0f2f5; padding: 20px; }

    h1 { text-align: center; margin-bottom: 20px; color: #333; }

    .formulario {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .formulario input, .formulario button {
      flex: 1 1 200px;
      min-width: 150px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }

    .btn-editar { background-color: #2196F3; }
    .btn-editar:hover { background-color: #1976D2; }
    .btn-excluir { background-color: #f44336; }
    .btn-excluir:hover { background-color: #d32f2f; }

    #resumo {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0px 0px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 10px;
      border: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #f8f9fa;
      color: #333;
    }
    td button {
      margin: 2px;
      font-size: 14px;
      padding: 5px 10px;
    }

    #grafico-container {
      margin-top: 30px;
    }

    @media(max-width: 768px) {
      .formulario { flex-direction: column; }
      table, thead, tbody, th, td, tr { display: block; }
      th, td { text-align: right; }
      td::before {
        content: attr(data-label);
        float: left;
        font-weight: bold;
      }
    }
  </style>
</head>

<body>

  <h1>Controle de Viagens üöö</h1>

  <div class="formulario">
    <input id="cliente" placeholder="Cliente">
    <input id="contato" placeholder="Contato">
    <input id="data" type="date">
    <input id="origem" placeholder="Origem">
    <input id="destino" placeholder="Destino">
    <input id="kmInicial" type="number" placeholder="KM Inicial">
    <input id="kmFinal" type="number" placeholder="KM Final">
    <input id="combustivel" type="number" placeholder="Combust√≠vel R$">
    <input id="pedagios" type="number" placeholder="Ped√°gios R$">
    <input id="outros" type="number" placeholder="Outros R$">
    <input id="ajudante" type="number" placeholder="Ajudante R$">
    <input id="frete" type="number" placeholder="Frete R$">
    <button onclick="adicionarViagem()">‚úö Adicionar</button>
    <button onclick="exportarExcel()">‚¨áÔ∏è Exportar XLSX</button>
    <button onclick="limparTabela()">üóëÔ∏è Limpar Tudo</button>
  </div>

  <div id="resumo">
    <h2>Resumo üìä</h2>
    <p>Viagens: <span id="resumo-viagens">0</span></p>
    <p>KM Rodado: <span id="resumo-km">0</span> km</p>
    <p>M√©dia Custo/KM: R$ <span id="resumo-media-km">0.00</span></p>
    <p>Frete Total: R$ <span id="resumo-frete">0.00</span></p>
    <p>Gastos Totais: R$ <span id="resumo-gastos">0.00</span></p>
    <p>Saldo Final: R$ <span id="resumo-saldo">0.00</span></p>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Cliente</th><th>Contato</th><th>Data</th><th>Origem ‚Üí Destino</th><th>KM</th>
        <th>Combust√≠vel</th><th>Ped√°gios</th><th>Outros</th><th>Ajudante</th>
        <th>Gastos</th><th>Custo/KM</th><th>Frete</th><th>Saldo</th><th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="grafico-container">
    <canvas id="graficoResumo" height="120"></canvas>
  </div>

<script>
// C√≥digo JavaScript igual ao anterior, s√≥ removi fun√ß√µes de backup, filtro e exportar CSV.

let chart;
let editando = null;

function adicionarViagem() {
  const dados = pegarDadosFormulario();
  if (!dados) return;

  if (editando !== null) {
    document.querySelectorAll("#tabela tbody tr")[editando].innerHTML = gerarHTMLLinha(dados);
    editando = null;
    document.querySelector('button[onclick="adicionarViagem()"]').innerText = "‚úö Adicionar";
  } else {
    document.querySelector("#tabela tbody").insertAdjacentHTML("beforeend", `<tr>${gerarHTMLLinha(dados)}</tr>`);
  }

  salvarDadosLocalmente();
  atualizarResumo();
  limparFormulario();
}

function pegarDadosFormulario() {
  const campos = ["cliente","contato","data","origem","destino","kmInicial","kmFinal","combustivel","pedagios","outros","ajudante","frete"];
  const dados = {};
  for (const id of campos) {
    dados[id] = document.getElementById(id).value;
    if (dados[id] === "") {
      alert("Preencha todos os campos!");
      return null;
    }
  }
  const kmRodado = parseFloat(dados.kmFinal) - parseFloat(dados.kmInicial);
  const totalGastos = ["combustivel","pedagios","outros","ajudante"].reduce((acc, key) => acc + parseFloat(dados[key]), 0);
  const custoPorKm = (kmRodado > 0 ? (totalGastos / kmRodado) : 0).toFixed(2);
  const saldoFinal = (parseFloat(dados.frete) - totalGastos).toFixed(2);

  return {...dados, kmRodado, totalGastos, custoPorKm, saldoFinal};
}

function gerarHTMLLinha(d) {
  const formatReal = v => `R$ ${parseFloat(v).toFixed(2)}`;
  return `
    <td>${d.cliente}</td><td>${d.contato}</td><td>${new Date(d.data).toLocaleDateString('pt-BR')}</td>
    <td>${d.origem} ‚Üí ${d.destino}</td><td>${d.kmRodado} km</td>
    <td>${formatReal(d.combustivel)}</td><td>${formatReal(d.pedagios)}</td><td>${formatReal(d.outros)}</td><td>${formatReal(d.ajudante)}</td>
    <td>${formatReal(d.totalGastos)}</td><td>${formatReal(d.custoPorKm)}</td><td>${formatReal(d.frete)}</td><td>${formatReal(d.saldoFinal)}</td>
    <td>
      <button class="btn-editar" onclick="editarViagem(this)">‚úèÔ∏è</button>
      <button class="btn-excluir" onclick="excluirViagem(this)">üóëÔ∏è</button>
    </td>`;
}

function limparFormulario() {
  document.querySelectorAll("input").forEach(i => i.value = "");
}

function editarViagem(btn) {
  const linha = btn.parentNode.parentNode;
  const celulas = linha.querySelectorAll("td");
  document.getElementById("cliente").value = celulas[0].innerText;
  document.getElementById("contato").value = celulas[1].innerText;
  document.getElementById("data").value = new Date(celulas[2].innerText.split("/").reverse().join("-")).toISOString().slice(0,10);
  document.getElementById("origem").value = celulas[3].innerText.split(" ‚Üí ")[0];
  document.getElementById("destino").value = celulas[3].innerText.split(" ‚Üí ")[1];
  editando = Array.from(linha.parentNode.children).indexOf(linha);
  document.querySelector('button[onclick="adicionarViagem()"]').innerText = "üíæ Salvar";
}

function excluirViagem(btn) {
  if (!confirm("Deseja excluir esta viagem?")) return;
  btn.parentNode.parentNode.remove();
  salvarDadosLocalmente();
  atualizarResumo();
}

function exportarExcel() {
  const wb = XLSX.utils.table_to_book(document.getElementById("tabela"), {sheet:"Viagens"});
  XLSX.writeFile(wb, "controle_viagens.xlsx");
}

function salvarDadosLocalmente() {
  const linhas = Array.from(document.querySelectorAll("#tabela tbody tr")).map(tr => 
    Array.from(tr.children).map(td => td.textContent));
  localStorage.setItem("viagens", JSON.stringify(linhas));
}

function carregarBackup() {
  const dados = JSON.parse(localStorage.getItem("viagens"));
  if (!dados) return;
  dados.forEach(linha => {
    const html = `<tr>${linha.slice(0,-1).map(c => `<td>${c}</td>`).join("")}<td><button class="btn-editar" onclick="editarViagem(this)">‚úèÔ∏è</button><button class="btn-excluir" onclick="excluirViagem(this)">üóëÔ∏è</button></td></tr>`;
    document.querySelector("#tabela tbody").insertAdjacentHTML("beforeend", html);
  });
}

function atualizarResumo() {
  const linhas = document.querySelectorAll("#tabela tbody tr");
  let viagens = 0, km = 0, gastos = 0, frete = 0, saldo = 0;
  const labels = [], fretes = [], custos = [];

  linhas.forEach(linha => {
    viagens++;
    const celulas = linha.querySelectorAll("td");
    km += parseFloat(celulas[4].innerText);
    gastos += parseFloat(celulas[9].innerText.replace("R$ ",""));
    frete += parseFloat(celulas[11].innerText.replace("R$ ",""));
    saldo += parseFloat(celulas[12].innerText.replace("R$ ",""));
    labels.push(celulas[3].innerText);
    fretes.push(parseFloat(celulas[11].innerText.replace("R$ ","")));
    custos.push(parseFloat(celulas[9].innerText.replace("R$ ","")));
  });

  document.getElementById("resumo-viagens").innerText = viagens;
  document.getElementById("resumo-km").innerText = km;
  document.getElementById("resumo-media-km").innerText = (km > 0 ? (gastos/km).toFixed(2) : "0.00");
  document.getElementById("resumo-frete").innerText = frete.toFixed(2);
  document.getElementById("resumo-gastos").innerText = gastos.toFixed(2);
  document.getElementById("resumo-saldo").innerText = saldo.toFixed(2);

  renderizarGrafico(labels, fretes, custos);
}

function renderizarGrafico(labels, fretes, custos) {
  const ctx = document.getElementById("graficoResumo").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Frete', data: fretes, backgroundColor: '#4CAF50' },
        { label: 'Gastos', data: custos, backgroundColor: '#f44336' }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'top' } } }
  });
}

carregarBackup();
</script>

</body>
</html>
